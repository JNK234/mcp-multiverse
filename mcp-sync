#!/bin/bash
# ABOUTME: Quick wrapper for MCP sync manager
# ABOUTME: Provides convenient shortcuts for common operations

# Color codes for output
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# MCP Sync Manager location
SYNC_MANAGER="${SYNC_MANAGER:-$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)/mcp-sync-manager.py}"

# Help function
show_help() {
    cat << EOF
Universal MCP Sync Manager - Quick Commands

USAGE:
    mcp-sync [COMMAND] [OPTIONS]

COMMANDS:
    list      List all MCP servers across platforms
    sync      Sync all servers to all platforms
    backup    Create backups of all config files
    diff      Show differences between platforms
    help      Show this help message

EXAMPLES:
    mcp-sync list                  # List all servers
    mcp-sync sync                  # Sync everything
    mcp-sync backup                # Backup all configs

MORE COMMANDS (use sync-manager directly):
    python3 mcp-sync-manager.py add [name] [command]    # Add server
    python3 mcp-sync-manager.py remove [name]          # Remove server

EOF
}

# List servers with formatting
list_servers() {
    echo -e "${BLUE}ðŸ” Listing all MCP servers...${NC}"
    python3 "$SYNC_MANAGER" list
}

# Sync all platforms
sync_all() {
    echo -e "${BLUE}ðŸ”„ Syncing MCP servers across all platforms...${NC}"
    python3 "$SYNC_MANAGER" sync

    if [ $? -eq 0 ]; then
        echo -e "${GREEN}âœ… Sync completed successfully!${NC}"
    else
        echo -e "${YELLOW}âš ï¸  Sync completed with errors. Check logs.${NC}"
        echo "Logs available at: /tmp/mcp-sync-manager.log"
    fi
}

# Create backups
backup_configs() {
    echo -e "${BLUE}ðŸ’¾ Creating backups of all configs...${NC}"

    BACKUP_DIR="$HOME/.mcp-manual-backups/$(date +%Y%m%d_%H%M%S)"
    mkdir -p "$BACKUP_DIR"

    # Claude
    if [ -f "$HOME/.claude/claude_desktop_config.json" ]; then
        cp "$HOME/.claude/claude_desktop_config.json" "$BACKUP_DIR/"
        echo "âœ“ Backed up Claude config"
    fi

    # Gemini
    if [ -f "$HOME/.gemini/settings.json" ]; then
        cp "$HOME/.gemini/settings.json" "$BACKUP_DIR/"
        echo "âœ“ Backed up Gemini config"
    fi

    # Cline
    CLINE_CONFIG="$HOME/Library/Application Support/Code/User/globalStorage/saoudrizwan.claude-dev/settings/cline_mcp_settings.json"
    if [ -f "$CLINE_CONFIG" ]; then
        cp "$CLINE_CONFIG" "$BACKUP_DIR/"
        echo "âœ“ Backed up Cline config"
    fi

    echo -e "${GREEN}âœ… Backups created in: $BACKUP_DIR${NC}"
}

# Show diff between platforms (simplified)
show_diff() {
    echo -e "${BLUE}ðŸ“Š Platform configuration summary:${NC}\n"

    # Count servers per platform
    CLADE_COUNT=$(python3 -c "
import json
import sys
try:
    with open(sys.argv[1]) as f:
        config = json.load(f)
        print(len(config.get('mcpServers', {})))
except:
    print(0)
" "$HOME/.claude/claude_desktop_config.json" 2>/dev/null || echo 0)

    GEMINI_COUNT=$(python3 -c "
import json
import sys
try:
    with open(sys.argv[1]) as f:
        config = json.load(f)
        print(len(config.get('mcpServers', {})))
except:
    print(0)
" "$HOME/.gemini/settings.json" 2>/dev/null || echo 0)

    CLINE_COUNT=$(python3 -c "
import json
import sys
try:
    with open(sys.argv[1]) as f:
        config = json.load(f)
        print(len(config.get('mcpServers', {})))
except:
    print(0)
" "$HOME/Library/Application Support/Code/User/globalStorage/saoudrizwan.claude-dev/settings/cline_mcp_settings.json" 2>/dev/null || echo 0)

    echo "Platform      | Servers"
    echo "--------------|--------"
    echo "Claude Code   | $CLADE_COUNT"
    echo "Gemini CLI    | $GEMINI_COUNT"
    echo "Cline         | $CLINE_COUNT"
    echo ""
    echo "Run 'mcp-sync sync' to synchronize"
}

# Main command handling
case "${1:-help}" in
    list|ls)
        list_servers
        ;;
    sync|s)
        sync_all
        ;;
    backup|b)
        backup_configs
        ;;
    diff|d)
        show_diff
        ;;
    help|h|--help|-h)
        show_help
        ;;
    *)
        echo -e "${YELLOW}Unknown command: $1${NC}"
        show_help
        exit 1
        ;;
esac
